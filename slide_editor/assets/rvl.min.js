/*!
* rvl.io 1.0.0 (2012-11-13, 23:34)
* http://www.rvl.io
*
* Copyright (C) 2012 rvl.io
*/
window.RVL = {}, window.RVL.views = {}, 
$(function() {
	RVL.reinit()
}), 
RVL.reinit = function() {
    function e() {
        var e = window.innerHeight - 1;
        $("body")
            .css("min-height", Math.max(e, 600)), $("#modal")
            .css("height", e)
    }
    RVL.IS_TOUCH_DEVICE = "ontouchstart" in window, e(), $(window)
        .resize(e), $("html")
        .addClass("loaded")
        .toggleClass("touch", RVL.IS_TOUCH_DEVICE);
    var t = $(document.body);
    t.hasClass("index-view") ? RVL.views.index() : t.hasClass("registration-view") ? RVL.views.registration() : t.hasClass("user-view") ? RVL.views.user() : t.hasClass("deck-view") ? RVL.views.deck() : t.hasClass("edit-view") ? RVL.views.edit() : RVL.views.text()

},
RVL.util = function() {
    return {
        getQuery: function() {
            var e = {};
            return location.search.replace(/[A-Z0-9]+?=(\w*)/gi, function(t) {
                e[t.split("=")
                    .shift()] = t.split("=")
                    .pop()
            }), e
        },
        formatHTML: function(e) {
            var t = "",
                n = /(>)(<)(\/*)/g,
                r = 0;
            return e = e.replace(n, "$1\r\n$2$3"), jQuery.each(e.split("\r\n"), function(e, n) {
                var i = 0;
                n.match(/.+<\/\w[^>]*>$/) ? i = 0 : n.match(/^<\/\w/) ? r !== 0 && (r -= 1) : n.match(/^<\w[^>]*[^\/]>.*$/) && !n.match(/^<(br|img).*>\s?$/) ? i = 1 : i = 0;
                var s = "";
                for (var o = 0; o < r; o++) s += " ";
                t += s + n + "\r\n", r += i
            }), t
        }
    }
}(), $(function() {
    RVL.modal = function() {
        var e = $("#modal"),
            t = $("#modal-cover");
        return $(document)
            .keyup(function(e) {
            e.keyCode === 27 && RVL.modal.close()
        }), $("#modal .close")
            .click(function() {
            RVL.modal.close()
        }), {
            closeTimeout: null,
            open: function(n, r) {
                if (n === "create") {
                    var i, s, o = !1,
                        u = !1,
                        a = $("#modal .create form"),
                        f = a.find("input[type=text]"),
                        l = a.find("input[type=submit]"),
                        c = $("#modal .create .error");
                    l.addClass("disabled"), f.keyup(function(e) {
                        h()
                    }), a.submit(function(e) {
                        o ? (u = !0, e.preventDefault()) : l.hasClass("disabled") && (alert("Please enter a valid name"), e.preventDefault())
                    });
                    var h = function() {
                        f.val()
                            .length > 1 ? (i && i.abort(), o = !0, clearTimeout(s), s = setTimeout(function() {
                            i = $.ajax({
                                url: "/ax/checkDeckName",
                                data: {
                                    deckName: f.val()
                                },
                                success: function(e) {
                                    e.nameValid === !0 ? (l.removeClass("disabled"), c.text("")) : (l.addClass("disabled"), c.text(e.errorMsg)), o = !1, u && a.submit(), u = !1
                                },
                                error: function(e, t) {
                                    l.addClass("disabled"), c.text(""), o = !1, u && a.submit(), u = !1
                                }
                            })
                        }, 250)) : l.addClass("disabled")
                    }
                } else n === "edit-html" ? (RVL.htmlEditor.env.document.setValue(RVL.util.formatHTML($(Reveal.getCurrentSlide())
                    .html())), RVL.htmlEditor.focus(), e.find(".discard-changes")
                    .click(function(e) {
                    RVL.modal.close()
                }), e.find(".save-changes").click(function(e) {
                    Reveal.getCurrentSlide()
                        .innerHTML = RVL.htmlEditor.env.document.getValue(), RVL.modal.close()
                })) : n === "settings" ? e.find(".done").click(function(e) {
                    RVL.modal.close()
                }) : n === "download" ? e.find(".done").click(function(e) {
                    RVL.modal.close()
                }) : n === "import" && e.find(".done").click(function(e) {
					var btnname = e.srcElement.innerHTML;
					var new_content = $("#modal .import #txt").val();
					if (btnname =="Replace" && new_content) {
					    //alert("replace with " + new_content);
						$(".reveal .slides").html(new_content);
						RVL.modal.close();
                        RVL.reinit();
					} else if (btnname =="Replace" && !new_content)
					{
						alert("empty");
					}
                    RVL.modal.close()
                });
                $("html")
                    .addClass("modal-open"), clearTimeout(this.closeTimeout), e.find(">div")
                    .removeClass("visible"), e.find("." + n)
                    .addClass("visible"), e.add(t)
                    .click(function(e) {
                    e.target === this && RVL.modal.close()
                })
            },
            close: function() {
                $("html")
                    .removeClass("modal-open"), e.find(".create form")
                    .unbind(), e.find(".create form input[type=text]")
                    .unbind(), e.find(".create form input[type=submit]")
                    .unbind(), this.closeTimeout = setTimeout(function() {
                    e.find(">div")
                        .removeClass("visible")
                }, 400)
            }
        }
    }()
}), RVL.notify = function(e, t, n) {
    var r = $("<p>")
        .html(e)
        .addClass(t || "")
        .appendTo($(".notifications"));
    setTimeout(function() {
        r.addClass("show"), setTimeout(function() {
            r.fadeOut(600, function() {
                $(this)
                    .remove()
            })
        }, n || 2e3)
    }, 1)
}, RVL.header = function() {
    function e() {
        var e = [{
            type: "openid",
            title: "OpenId",
            img: "openid.png",
            hint: "<strong>http://{your-openid-url}</strong>"
        }, {
            type: "direct",
            title: "Google",
            img: "google.png",
            hint: "https://www.google.com/accounts/o8/id"
        }, {
            type: "direct",
            title: "Yahoo",
            img: "yahoo.png",
            hint: "http://yahoo.com"
        }, {
            type: "username",
            title: "AOL screen name",
            img: "aol.png",
            hint: "http://openid.aol.com/<strong>username</strong>"
        }],
            t = "";
        $.each(e, function(e, n) {
            t += ['<li class="', n.type, '" title="', n.title, '"><img src="/s/assets/images/openid/', n.img, '" alt="icon" width="150" height="70" /><span>', n.hint, "</span></li>"].join("")
        }), $(".login .providers")
            .html(t)
    }
    $("a.sign-in, a.sign-up")
        .click(function(t) {
        t.preventDefault(), e(), typeof $("form.openid")
            .openid == "function" ? ($("form.openid")
            .openid(), RVL.modal.open("login")) : RVL.modal.open("create")
    }), $("a.create-deck")
        .click(function(e) {
        e.preventDefault(), RVL.modal.open("create"), setTimeout(function() {
            $("#modal .create input[type=text]")
                .focus()
        }, 50)
    })
}, RVL.views.registration = function() {
    function f() {
        t.val()
            .length > 2 && t.val()
            .match(/^[a-zA-Z][0-9a-zA-Z_]+$/gi) ? (s && s.abort(), u = !0, clearTimeout(i), i = setTimeout(function() {
            s = $.ajax({
                url: "/ax/checkUserName",
                data: {
                    userName: t.val()
                },
                success: function(t) {
                    t.nameValid === !0 ? (o = !1, r.text(""), n.removeClass("disabled")) : (o = !0, r.text(t.errorMsg), n.addClass("disabled")), u = !1, a && e.submit(), a = !1
                },
                error: function(t, i) {
                    o = !0, r.text(""), n.addClass("disabled"), u = !1, a && e.submit(), a = !1
                }
            })
        }, 250)) : n.addClass("disabled")
    }
    var e = $("#username-form"),
        t = e.find("input[type=text]"),
        n = e.find("input[type=submit]"),
        r = $(".marquee .error"),
        i = -1,
        s = null,
        o = !1,
        u = !1,
        a = !1;
    t.keyup(function(e) {
        o = !1, f()
    }), e.submit(function(e) {
        u ? (a = !0, e.preventDefault()) : n.hasClass("disabled") && (alert("Please enter a valid name"), e.preventDefault())
    })
}, RVL.views.index = function() {
    RVL.header(), setTimeout(function() {
        $(".features-promo")
            .css("opacity", 1)
    }, 600), $(".features-promo a")
        .on("click", function(e) {
        return $("html, body")
            .animate({
            scrollTop: $("#features")
                .offset()
                .top - 20
        }, 1e3), !1
    }), $("#main .demo")
        .on("click", function(e) {
        if (!RVL.IS_TOUCH_DEVICE && $("#demo-video")
            .length === 0) {
            var t = Math.min($("#main")
                .width() * .7, window.innerHeight * .8);
            $("#main")
                .append('<iframe id="demo-video" width="100%" height="' + t + '" src="http://www.youtube.com/embed/LyWAc7dBvmA?autoplay=1&vq=hd720" frameborder="0" allowfullscreen></iframe>'), $("html, body")
                .animate({
                scrollTop: $("#demo-video")
                    .offset()
                    .top - 20
            }, 1e3), e.preventDefault()
        }
    })
}, RVL.views.user = function() {
    RVL.header(), $(".decks li .edit")
        .click(function(e) {
        e.preventDefault(), window.location = $(this)
            .parents("li")
            .data("url") + "/edit"
    }), $(".decks li .delete")
        .click(function(e) {
        e.preventDefault();
        var t = $(this)
            .parents("li"),
            n = t.data("deckname");
        confirm('Are you sure you want to delete "' + n + '"?') && (t.find(".details span")
            .text("Deleting..."), $.post("/ax/deleteDeck", {
            deckName: n
        }, function(e) {
            e.success ? (RVL.notify("Deck deleted", "negative"), t.remove()) : RVL.notify("Failed to delete", "negative")
        }))
    }), $(".decks li .unpublish")
        .click(function(e) {
        e.preventDefault();
        var t = $(this)
            .parents("li"),
            n = t.data("deckname");
        confirm('Are you sure you want to make "' + n + '" private?') && (t.find(".details span")
            .text("Unpublishing..."), $.post("/ax/unpublishDeck", {
            deckName: n
        }, function(e) {
            e.success ? (t.find(".details span")
                .text("Private"), t.removeClass("public")
                .addClass("private"), RVL.notify("Deck unpublished", "positive")) : RVL.notify("Failed to unpublish", "negative")
        }))
    }), $(".decks li .publish")
        .click(function(e) {
        e.preventDefault();
        var t = $(this)
            .parents("li"),
            n = t.data("deckname");
        confirm('Are you sure you want to make "' + n + '" public?') && (t.find(".details span")
            .text("Publishing..."), $.post("/ax/publishDeck", {
            deckName: n
        }, function(e) {
            e.success ? (t.find(".details span")
                .text("Published"), t.removeClass("private")
                .addClass("public"), RVL.notify("Deck published", "positive")) : RVL.notify("Failed to publish", "negative")
        }))
    }), $(".decks li")
        .click(function(e) {
        e.target.nodeName.match(/^a$/i) === null && (e.preventDefault(), window.location = $(this)
            .find(">h2 a")
            .attr("href"))
    })
}, RVL.views.edit = function() {
    function u() {
        Reveal.initialize({
            controls: !0,
            progress: !0,
            history: !1,
            center: !1,
            mouseWheel: !1,
            rollingLinks: !1,
            transition: RevealDeckSettings.transition,
            dependencies: [{
                src: "./assets/highlight.js",
                async: !0,
                callback: function() {
                    window.hljs.initHighlightingOnLoad()
                }
            }, {
                src: "../lib/js/classList.js",
                condition: function() {
                    return !document.body.classList
                }
            }, {
                src: "../plugin/markdown/showdown.js",
                condition: function() {
                    return !!document.querySelector("[data-markdown]")
                }
            }, {
                src: "./assets/data-markdown.js",
                condition: function() {
                    return !!document.querySelector("[data-markdown]")
                }
            }]
        }), Reveal.addEventListener("slidechanged", function() {
            v()
        })
    }
    function a() {
        try {
            RVL.htmlEditor = ace.edit("ace"), RVL.htmlEditor.setTheme("ace/theme/monokai"), RVL.htmlEditor.setShowPrintMargin(!1);
            var e = require("ace/mode/html")
                .Mode;
            RVL.htmlEditor.getSession()
                .setMode(new e)
        } catch (t) {
            console.log("An error occurred while initializing the Ace editor.")
        }
    }
    function f() {
        var e = $(Reveal.getCurrentSlide());
        return e.parent("section.stack")
            .length && (e = e.parent("section.stack")), e
    }
    function l() {
        s = p() !== i, s ? $(".save-deck")
            .text("Save")
            .removeClass("disabled") : $(".save-deck")
            .text("Saved")
            .addClass("disabled")
    }
	function ll_local() {  // TODO:
		var iii = i;
		var ppp = p();
		var bbb = iii == ppp;
        s = p() !== i, s ? $(".save-deck-local")
            .text("Save locally")
            .removeClass("disabled") : $(".save-deck-local")
            .text("Saved locally")
            .addClass("disabled")
    }
	function import_deck() {
		RVL.modal.open("import")
	}
	function clean_local() {  // TODO:exception
		localStorage.removeItem("savedslides");
		$(".reveal .slides").html(orig_content);

		RVL.reinit();
	}
    function c() {  // TODO: disable this
        $(".save-deck")
            .text("Saving")
            .addClass("disabled");
        var e = p();
        $.post("/ax/updateDeck", $.extend({}, RevealConfig, {
            deckContent: e
        }), function(t) {
            t.updated ? (RevealConfig.currVersion = t.nextVersion, RVL.notify("Saved successfully", "positive")) : RVL.notify("Failed to save", "negative"), i = e, l()
        })
    }
    function cc_saving_local() {
        $(".save-deck-local")
            .text("Saving")
            .addClass("disabled");
        var e = p();
        // save localstorage
		// TODO: check browser support for localStorage
		var savedslides = localStorage.getItem("savedslides");  
		if (savedslides != e) localStorage["savedslides"] = e;
		i = e;  // TODO: i will affected to network saving judgement. fix this when you fix network saving 
		ll_local();
    }
    function h() {
        $.post("/ax/updateDeckSettings", $.extend({}, RevealConfig, {
            deckThemeFont: RevealDeckSettings.themeFont,
            deckThemeColor: RevealDeckSettings.themeColor,
            deckTransition: RevealDeckSettings.transition
        }), function(e) {
            e.updated || RVL.notify("Failed to save settings", "negative")
        })
    }
    function p() {
        var e = $(".reveal .slides")
            .children()
            .map(function() {
            var e = $(this)
                .clone();
            return e.find("section")
                .add(e)
                .each(function() {
                var e = $.map(this.attributes, function(e) {
                    return e.name
                }),
                    t = $(this);
                $.each(e, function(e, n) {
                    t.removeAttr(n)
                })
            }), e.wrap("<div>")
                .parent()
                .html()
        })
            .toArray()
            .join("");
        return e = e.replace("</iframe>", " </iframe>"), e
    }
    function d(e) {
        var t = e ? $(e) : $(".reveal .slides section:not(.stack)");
        t.each(function() {
            var e = $(this)
                .attr("id", "s-" + r++);
            o.addInstance(e.get(0))
        })
    }
    function v() {
        e.addClass("show"), t.addClass("show")
    }
    function m(e, t) {
        e && t && (RevealDeckSettings.themeFont = e, RevealDeckSettings.themeColor = t, $("#theme")
            .attr({
            href: $("#theme")
                .attr("href")
                .replace(/[a-z0-9\-_]*\.css/gi, e + "_" + t + ".css")
        }), g(), h())
    }
    function g() {
        $("#modal .settings .theme li")
            .removeClass("selected"), $("#modal .settings .theme li[data-font=" + RevealDeckSettings.themeFont + "]")
            .filter("li[data-color=" + RevealDeckSettings.themeColor + "]")
            .addClass("selected")
    }
    function y(e) {
        e && (RevealDeckSettings.transition = e, $("#modal .settings .transition li")
            .each(function() {
            $(".reveal")
                .removeClass($(this)
                .attr("data-transition"))
        }), $(".reveal")
            .addClass(e), b(), h())
    }
    function b() {
        $("#modal .settings .transition li")
            .removeClass("selected"), $("#modal .settings .transition li[data-transition=" + RevealDeckSettings.transition + "]")
            .addClass("selected")
    }
    function w() {
        var e = $(".reveal .slides"),
            t = $(".reveal .slides:not(.stack) .present"),
            r = {
                left: e.offset()
                    .left - t.width() / 2,
                top: e.offset()
                    .top - 300
            };
        t.parent(".stack")
            .length && (r.top += 20), n.css(r)
    }
    function E(e) {
        $(".reveal .slides section")
            .length > 1 && (n.show(), w())
    }
    function S(e) {
        var t = $(e.target);
        n.hide()
    }
    function x(e) {
        e.preventDefault();
        var t = $('<section class="future"><h2>Title</h2></section>')
            .insertAfter(f());
        setTimeout(Reveal.navigateRight, 1), d(t.get(0))
    }
    function T(e) {
        e.preventDefault();
        var t = $(".reveal .slides>.present");
        t.hasClass("stack") || (t.wrapInner("<section>")
            .addClass("present")
            .removeAttr("contenteditable"), d(t.find(">section")
            .get(0)), Reveal.navigateDown());
        var n = $('<section class="future"><h2>Title</h2></section>')
            .insertAfter(Reveal.getCurrentSlide());
        d(n.get(0)), setTimeout(function() {
            Reveal.navigateDown()
        }, 1)
    }
    function N(e) {
        confirm("Are you sure you want to remove this slide?") && ($(".reveal .slides .present .present")
            .remove()
            .length === 0 ? $(".reveal .slides>section")
            .length > 1 && $(".reveal .slides>.present")
            .remove() : $(".reveal .slides .present>section")
            .length === 1 && $(".reveal .slides .present>section:eq(0)")
            .unwrap(), Reveal.navigateTo(), v())
    }
    function C(e) {
        var t = $(".reveal .slides")
            .children()
            .map(function() {
            var e = $(this)
                .clone();
            return e.find("section")
                .add(e)
                .each(function() {
                var e = $.map(this.attributes, function(e) {
                    return e.name
                }),
                    t = $(this);
                $.each(e, function(e, n) {
                    t.removeAttr(n)
                })
            }), e.wrap("<div>")
                .parent()
                .html()
        })
            .toArray()
            .join("");
        t = '<div class="slides">' + t + "</div>\n<!-- end of slides -->\n\n";
        var n = RVL.util.formatHTML(t);
        $("#modal .download textarea")
            .text(n), RVL.modal.open("download")
    }
    function k(e) {
        c()
    }
	function kk_local(e) {
		cc_saving_local()
	}
    function L(e) {
        e.preventDefault();
        if (!s || confirm("You have unsaved changes, continue anyway?")) {
            var t = $(".reveal .slides>.present")
                .index(),
                n = $(".reveal .slides>.present>.present")
                    .index();
            window.open(window.location.href.replace("/edit", "/#/" + t + (n === 0 || n === -1 ? "" : "/" + n)), "_blank")
        }
    }
    function A(e) {
        RVL.modal.open("settings")
    }
    function O(e) {
        e.preventDefault(), $(this)
            .text("Working..."), $.post("/ax/publishDeck", {
            deckName: RevealConfig.deckName
        }, function(e) {
            e.success ? ($(".options .publish")
                .removeClass("publish")
                .addClass("unpublish")
                .text("Unpublish"), RVL.notify("Published", "positive")) : RVL.notify("Failed to unpublish", "negative")
        })
    }
    function M(e) {
        e.preventDefault(), $(this)
            .text("Working..."), $.post("/ax/unpublishDeck", {
            deckName: RevealConfig.deckName
        }, function(e) {
            e.success ? ($(".options .unpublish")
                .removeClass("unpublish")
                .addClass("publish")
                .text("Publish"), RVL.notify("Unpublished", "positive")) : RVL.notify("Failed to unpublish", "negative")
        })
    }
    function _(e) {
        m($(this)
            .data("font"), $(this)
            .data("color"))
    }
    function D(e) {
        y($(this)
            .data("transition"))
    }
    function P(e) {
        e.keyCode === 27 && $(".reveal .slides .present[contenteditable]")
            .blur()
    }
    function H(e) {
        if (s) return "You will lose your unsaved changes."
    }
    function B(e) {
        w()
    }
	function load_localstorage() {
		// TODO: clean localsotrage function.
		orig_content = $(".reveal .slides").html();
		var savedslides = localStorage.getItem("savedslides"); 
		if (savedslides) {
			$(".reveal .slides").html(savedslides);
		}
	}
    RVL.header(), window.RevealDeckSettings || (window.RevealDeckSettings = {}), RevealDeckSettings.themeFont = RevealDeckSettings.themeFont || "league", RevealDeckSettings.themeColor = RevealDeckSettings.themeColor || "grey-blue", RevealDeckSettings.transition = RevealDeckSettings.transition || "default";
    var e = $(".add-horizontal-slide"),
        t = $(".add-vertical-slide"),
        n = $(".remove-slide"),
        r = 0,
        i = null,
        s = !1,
        orig_content = "",
        o = new nicEditor;
	setInterval(ll_local, 1e3),
	load_localstorage(),
        $('#toolbar').html(""),
    o.setPanel("toolbar"), u(), a(), v(), d(), b(), g(), i = p(), setInterval(l, 1e3), head.js("./assets/highlight.js", function() {
        hljs.initHighlightingOnLoad()
    }), $(".reveal .slides section.present")
        .live("focus", E), $(".reveal .slides section.present")
        .live("blur", S), 
			$(".options .save-deck").on("click", k), 
			$(".options .save-deck-local").on("click", kk_local), 
			$(".options .import-deck").on("click", import_deck), 
			$(".options .clean-local").on("click", clean_local), 
			$(".options .download-deck").on("click", C), 
			$(".options .preview-deck")
        .on("click", L), $(".options .settings")
        .on("click", A), $(".options .publish")
        .live("click", O), $(".options .unpublish")
        .live("click", M), $("#modal .settings .theme li")
        .on("click", _), $("#modal .settings .transition li")
        .on("click", D), $(window)
        .on("keyup", P), $(window)
        .on("beforeunload", H), $(window)
        .on("resize", B), e.on("click", x), t.on("click", T), n.on("mousedown", N)
}, RVL.views.deck = function() {
    Reveal.initialize({
        controls: !0,
        progress: !0,
        history: !1,
        center: !1,
        mouseWheel: !1,
        transition: RevealDeckSettings.transition,
        dependencies: [{
            src: "./assets/highlight.js",
            async: !0,
            callback: function() {
                window.hljs.initHighlightingOnLoad()
            }
        }, {
            src: "../lib/js/classList.js",
            condition: function() {
                return !document.body.classList
            }
        }, {
            src: "../plugin/markdown/showdown.js",
            condition: function() {
                return !!document.querySelector("[data-markdown]")
            }
        }, {
            src: "./assets/data-markdown.js",
            condition: function() {
                return !!document.querySelector("[data-markdown]")
            }
        }]
    }), $("a")
        .each(function() {
        $(this)
            .attr("href")
            .match(/^#/gi) || $(this)
            .attr("target", "_blank")
    })
}, RVL.views.text = function() {
    RVL.header()
};